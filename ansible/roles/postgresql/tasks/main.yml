---
 - name: create postgres account
   user:
      name: postgres
      comment: "Postgres Admin"
      group: postgres

 - name: install postgresql packages
   become: yes
   apt: name={{item}}
   with_items:
       - postgresql
       - libpq-dev
       - python-psycopg2
   become_user: postgres

 - name: ensure database is created
   become: yes
   postgresql_db: 
     name: "{{dbname}}"
     owner: "{{dbuser}}"
     encoding: UTF8
     lc_ctype: "{{locale}}"
     lc_collate: "{{locale}}"
     template: template0
   become_user: postgres

 - name: ensure user has access to database
   become: yes
   postgresql_user: db={{dbname}} name={{dbuser}} password={{dbpassword}} priv=ALL
   become_user: postgres

 - name: ensure user does not have unnecessary privilege
   become: yes
   postgresql_user: name={{dbuser}} role_attr_flags=NOSUPERUSER,NOCREATEDB
   become_user: postgres
  
 - name: ensure no other user can access the database
   become: yes
   postgresql_privs: db={{dbname}} role=PUBLIC type=database priv=ALL state=absent
   become_user: postgres
